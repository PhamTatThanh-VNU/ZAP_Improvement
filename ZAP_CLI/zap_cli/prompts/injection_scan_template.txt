// Note that new active scripts will initially be disabled
// Right click the script in the Scripts tree and select "enable"

const ScanRuleMetadata = Java.type("org.zaproxy.addon.commonlib.scanrules.ScanRuleMetadata");
const Control = Java.type("org.parosproxy.paros.control.Control");
const ExtensionOast = Java.type("org.zaproxy.addon.oast.ExtensionOast");

function getMetadata() {
    return ScanRuleMetadata.fromYaml(`
id: {{SCAN_ID}}
name: {{SCAN_NAME}}
description: {{SCAN_DESCRIPTION}}
solution: {{SOLUTION}}
category: {{CATEGORY}}
risk: {{RISK}}
confidence: {{CONFIDENCE}}
cweId: {{CWE_ID}}
wascId: {{WASC_ID}}
status: alpha
`);
}

/* Injection config - Generated by LLM */
const CONFIG = {{CONFIG_JSON}};

/**
 * Get OAST Extension instance
 */
function getOastExtension() {
    try {
        return Control.getSingleton()
            .getExtensionLoader()
            .getExtension(ExtensionOast.class);
    } catch (e) {
        print("OAST Extension not available: " + e);
        return null;
    }
}

/**
 * Scans a parameter.
 */
function scan(as, msg, param, value) {
    print('scan ' + msg.getRequestHeader().getURI() + ' param=' + param);

    var threshold = as.getAlertThreshold();
    var strength = as.getAttackStrength();

    /* ERROR-BASED */
    if (CONFIG.enabled.error && (threshold == "LOW" || threshold == "MEDIUM" || threshold == "HIGH")) {
        for (var i = 0; i < CONFIG.error.payloads.length; i++) {
            var p = CONFIG.error.payloads[i];
            var m = msg.cloneRequest();
            as.setParam(m, param, p);
            as.sendAndReceive(m, false, false);
    
            var body = m.getResponseBody().toString();
            var header = m.getResponseHeader().toString();
    
            for (var j = 0; j < CONFIG.error.signals.length; j++) {
                var sig = CONFIG.error.signals[j];
                if (sig.test(body) || sig.test(header)) {
                    as.newAlert()
                        .setParam(param)
                        .setAttack(p)
                        .setEvidence(sig.toString())
                        .setMessage(m)
                        .raise();
                    return;
                }
            }
        }
    }

    /* BOOLEAN-BASED */
    if (CONFIG.enabled.boolean && threshold != "LOW") {
        var t = msg.cloneRequest();
        var f = msg.cloneRequest();

        as.setParam(t, param, value + CONFIG.boolean.truePayload);
        as.setParam(f, param, value + CONFIG.boolean.falsePayload);

        as.sendAndReceive(t, false, false);
        as.sendAndReceive(f, false, false);

        if (t.getResponseBody().length() != f.getResponseBody().length()) {
            as.newAlert()
                .setParam(param)
                .setAttack("boolean-based: true=" + CONFIG.boolean.truePayload + ", false=" + CONFIG.boolean.falsePayload)
                .setEvidence("Response length difference: " + t.getResponseBody().length() + " vs " + f.getResponseBody().length())
                .setMessage(t)
                .raise();
            return;
        }
    }

    /* TIME-BASED */
    if (CONFIG.enabled.time && (strength == "HIGH" || strength == "INSANE")) {
        for (var i = 0; i < CONFIG.time.payloads.length; i++) {
            var p = CONFIG.time.payloads[i];
            var m = msg.cloneRequest();
            var start = Date.now();

            as.setParam(m, param, value + p);
            as.sendAndReceive(m, false, false);

            if (Date.now() - start > CONFIG.time.delayMs) {
                as.newAlert()
                    .setParam(param)
                    .setAttack("time-based: " + p)
                    .setEvidence("Response delayed by " + (Date.now() - start) + "ms (expected: " + CONFIG.time.delayMs + "ms)")
                    .setMessage(m)
                    .raise();
                return;
            }
        }
    }

    /* OAST */
    if (CONFIG.enabled.oast) {
        try {
            var extOast = getOastExtension();
            if (!extOast || !extOast.getActiveScanOastService()) {
                print("OAST service not available");
                return;
            }

            for (var i = 0; i < CONFIG.oast.payloads.length; i++) {
                var m = msg.cloneRequest();

                var alert = as.newAlert()
                        .setConfidence(2)
                        .setParam(param)
                        .setMessage(m)
                        .build();

                var oastPayload = extOast.registerAlertAndGetPayloadForCallbackService(alert, 'BOAST');
                print('OAST Payload: ' + oastPayload);
                var finalPayload = CONFIG.oast.payloads[i].replace("{{oast}}", oastPayload);
                print('Final Payload: ' + finalPayload);
                alert.setAttack(finalPayload);
                as.setParam(m, param, finalPayload);
                as.sendAndReceive(m, false, false);
            }
        } catch (e) {
            print("OAST test error: " + e);
        }
    }
}
