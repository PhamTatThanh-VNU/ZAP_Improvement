"""Vulnerability Research Chat - Clean Interface"""
import sys
import os
import json
import streamlit as st
from pathlib import Path
from datetime import datetime

sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from ui.config import DEFAULT_CONFIG
from ui.database import ChatDatabase
from ui.services import VulnerabilityAI
from zap_cli.script_generator import ZapScriptGenerator
from zap_cli.logger import setup_logger

SUGGESTIONS = {
    "SQL Injection": "How to detect SQL Injection vulnerabilities?",
    "XSS Attack": "What is Cross-Site Scripting and how to prevent it?",
    "Authentication": "Common authentication vulnerabilities in web apps",
    "File Upload": "Security risks with file upload features",
}

def init():
    """Initialize database, AI service, and default session"""
    if 'db' not in st.session_state:
        st.session_state.db = ChatDatabase()
    
    if 'ai' not in st.session_state:
        st.session_state.ai = VulnerabilityAI()
    
    # Initialize messages list
    if 'messages' not in st.session_state:
        st.session_state.messages = []
    
    # Initialize script generation state
    if 'pending_script_gen' not in st.session_state:
        st.session_state.pending_script_gen = None
    if 'show_url_input' not in st.session_state:
        st.session_state.show_url_input = False
    
    # Ensure default session exists
    if 'current_session_id' not in st.session_state:
        db = st.session_state.db
        sessions = db.get_sessions()
        
        if not sessions:
            # Create default session
            session_id = db.create_session("Default Chat")
            st.session_state.current_session_id = session_id
        else:
            # Use most recent session
            st.session_state.current_session_id = sessions[0][0]
        
        # Load messages from current session
        messages = db.get_messages(st.session_state.current_session_id)
        st.session_state.messages = [
            {"role": role, "content": content} 
            for role, content, _, _ in messages
        ]


def clear_chat():
    """Clear current chat and create new session"""
    db = st.session_state.db
    session_name = f"Chat {datetime.now().strftime('%Y-%m-%d %H:%M')}"
    new_session_id = db.create_session(session_name)
    st.session_state.current_session_id = new_session_id
    st.session_state.messages = []
    st.session_state.initial_question = None
    st.session_state.selected_suggestion = None


@st.dialog("Menu")
def show_sessions_dialog():
    """Show dialog to manage chat sessions"""
    db = st.session_state.db
    
    st.subheader("Chat Sessions")
    
    # New Chat section
    with st.container():
        st.write("**Start New Conversation**")
        col1, col2 = st.columns([3, 1])
        with col1:
            new_name = st.text_input(
                "Session name (optional):",
                placeholder="Leave blank for auto-generated name",
                key="new_session_input",
                label_visibility="collapsed"
            )
        with col2:
            if st.button("Create", use_container_width=True, type="primary"):
                if new_name:
                    session_name = new_name
                else:
                    session_name = f"Chat {datetime.now().strftime('%H:%M')}"
                
                new_sid = db.create_session(session_name)
                st.session_state.current_session_id = new_sid
                st.session_state.messages = []
                st.session_state.initial_question = None
                st.session_state.selected_suggestion = None
                st.rerun()
    
    st.divider()
    
    # Sessions list
    st.write("**Your Sessions**")
    sessions = db.get_sessions()
    
    if not sessions:
        st.info("No sessions yet. Create one above!")
        return
    
    for sid, name, created, _ in sessions:
        is_current = (sid == st.session_state.current_session_id)
        
        with st.container():
            col1, col2 = st.columns([5, 1])
            
            with col1:
                btn_label = f"‚úì {name}" if is_current else name
                if st.button(
                    btn_label,
                    key=f"sess_{sid}",
                    use_container_width=True,
                    disabled=is_current,
                    type="primary" if is_current else "secondary"
                ):
                    st.session_state.current_session_id = sid
                    messages = db.get_messages(sid)
                    st.session_state.messages = [
                        {"role": role, "content": content}
                        for role, content, _, _ in messages
                    ]
                    st.rerun()
            
            with col2:
                if not is_current:
                    if st.button("√ó", key=f"del_{sid}", help="Delete session"):
                        db.delete_session(sid)
                        st.rerun()


def render():
    init()
    db = st.session_state.db
    ai = st.session_state.ai
    
    # Config check
    missing = [k for k in ["gemini_api_key", "astra_token", "astra_endpoint"] 
               if not DEFAULT_CONFIG.get(k)]
    if missing:
        st.error(f"‚ö†Ô∏è Missing config: {', '.join(missing)}")
        st.stop()
    
    # Title bar with controls
    col1, col2 = st.columns([10, 1])
    with col1:
        st.title("Vulnerability Research Chat")
    with col2:
        if st.button("Menu", use_container_width=True):
            show_sessions_dialog()
    
    # Check if this is first interaction
    user_just_asked = 'initial_question' in st.session_state and st.session_state.initial_question
    user_clicked_suggestion = 'selected_suggestion' in st.session_state and st.session_state.selected_suggestion
    first_interaction = user_just_asked or user_clicked_suggestion
    has_history = len(st.session_state.messages) > 0
    
    # Show welcome screen if no messages
    if not first_interaction and not has_history:
        with st.container():
            st.markdown("### Welcome to Vulnerability Research Chat")
            st.markdown("Ask me anything about web security, vulnerabilities, and penetration testing.")
            
            # Initial chat input
            st.chat_input("Ask a question...", key="initial_question")
            
            # Suggestion pills
            st.pills(
                label="Quick Examples",
                label_visibility="visible",
                options=SUGGESTIONS.keys(),
                key="selected_suggestion"
            )
        
        st.stop()
    
    # Get user message
    user_message = st.chat_input("Ask a follow-up...")
    
    if not user_message:
        if user_just_asked:
            user_message = st.session_state.initial_question
        if user_clicked_suggestion:
            user_message = SUGGESTIONS[st.session_state.selected_suggestion]
    
    # Display chat history
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"], unsafe_allow_html=True)
    
    # Process new message
    if user_message:
        with st.chat_message("user"):
            st.write(user_message)
        
        st.session_state.messages.append({"role": "user", "content": user_message})
        db.add_message(st.session_state.current_session_id, "user", user_message)
        
        # Get AI response
        ctx = {'db': db}
        with st.chat_message("assistant"):
            with st.spinner("Thinking..."):
                try:
                    response = ai.process(user_message, st.session_state.current_session_id, ctx)
                except Exception as e:
                    response = f"Error: {e}"
            
            st.markdown(response, unsafe_allow_html=True)
        
        st.session_state.messages.append({"role": "assistant", "content": response})
        db.add_message(st.session_state.current_session_id, "assistant", response)
        
        # Check if this was a vulnerability question to offer script generation
        if ai._is_vulnerability_question(user_message):
            st.session_state.pending_script_gen = user_message
        
        if 'initial_question' in st.session_state:
            del st.session_state.initial_question
        if 'selected_suggestion' in st.session_state:
            del st.session_state.selected_suggestion
    
    # Show script generation confirmation
    if st.session_state.pending_script_gen and not st.session_state.show_url_input:
        st.divider()
        st.info("üí° Would you like to generate a ZAP active scan script for this vulnerability?")
        col1, col2 = st.columns([5, 5])
        with col1:
            if st.button("‚úì Yes, Generate", type="primary", use_container_width=True):
                st.session_state.show_url_input = True
                st.rerun()
        with col2:
            if st.button("‚úó No, Skip", use_container_width=True):
                st.session_state.pending_script_gen = None
                st.rerun()
    
    # Show URL input and generate script
    if st.session_state.show_url_input:
        st.divider()
        with st.container():
            st.subheader("üéØ Generate & Test Script")
            
            col1, col2 = st.columns([3, 1])
            with col1:
                test_url = st.text_input(
                    "Target URL for testing:",
                    placeholder="http://testphp.vulnweb.com",
                    key="test_url_input"
                )
            with col2:
                st.write("")
                st.write("")
                generate_btn = st.button("Generate & Test", type="primary", use_container_width=True)
            
            if generate_btn and test_url:
                with st.spinner("Generating script and validating..."):
                    try:
                        # Get last research result from database
                        research = db.get_research(st.session_state.current_session_id)
                        if research:
                            query, analysis, config_json, created_at = research[0]
                            
                            config_info = None
                            if config_json:
                                try:
                                    # Remove any extra whitespace or invalid characters
                                    config_json = config_json.strip()
                                    config_info = json.loads(config_json)
                                except json.JSONDecodeError as json_err:
                                    st.error(f"Invalid JSON in database: {json_err}")
                                    st.code(config_json[:200], language="text")
                            
                            if config_info:
                                # Initialize script generator
                                zap_config = {
                                    "apikey": DEFAULT_CONFIG.get("zap_apikey", ""),
                                    "zap_address": DEFAULT_CONFIG.get("zap_address", "localhost"),
                                    "zap_port": DEFAULT_CONFIG.get("zap_port", 8090)
                                }
                                
                                generator = ZapScriptGenerator(
                                    gemini_api_key=DEFAULT_CONFIG["gemini_api_key"],
                                    zap_config=zap_config,
                                    logger=setup_logger()
                                )
                                
                                # Generate and validate
                                result = generator.generate_and_validate(config_info, test_url)
                                
                                if result["success"] and result.get("validated"):
                                    st.success(f"‚úÖ Script generated and validated successfully!")
                                    st.code(f"File: {result['path']}", language="text")
                                elif result["success"]:
                                    st.warning(f"‚ö†Ô∏è Script generated but validation failed: {result['path']}")
                                else:
                                    st.error(f"‚ùå Generation failed: {result.get('error', 'Unknown error')}")
                            else:
                                st.error("No config_info found in research results")
                        else:
                            st.error("No research results found")
                    
                    except Exception as e:
                        st.error(f"Error: {e}")
                
                # Reset state
                st.session_state.pending_script_gen = None
                st.session_state.show_url_input = False


